{"title":"体验 GitHub Actions 自动部署 Hexo 博客","slug":"体验GitHub-Actions自动部署Hexo博客","date":"2019-09-05T00:00:00.000Z","updated":"2019-11-05T16:07:41.005Z","comments":true,"path":"api/articles/体验GitHub-Actions自动部署Hexo博客.json","excerpt":null,"covers":null,"content":"<p>博客原先是使用 <a href=\"https://travis-ci.org/\" title=\"Travis CI\" target=\"_blank\" rel=\"noopener\">Travis</a> 实现自动部署的，现 GitHub 有个 <a href=\"https://github.com/features/actions\" title=\"GitHub Actions\" target=\"_blank\" rel=\"noopener\">Actions</a> 体验 CI 功能就试试。项目中还保留着 Travis 配置，只是关掉了，不能使用 Actions 的是可以使用 Travis。</p>\n<blockquote>\n<p>GitHub 操作可让您灵活地构建自动化的软件部署生命周期工作流程。您可以编写个别任务、调用的操作，以及结合它们创建自定义工作流程。 工作流程是您可以在仓库中创建的自定义自动化流程，用于在 GitHub 上构建、测试、封装、发行或部署任何代码项目。</p>\n</blockquote>\n<p>GitHub Actions 目前采用 <a href=\"yaml\">YAML</a> 语法，还处于体验版，何时能正式上线就不知道了。毕竟 <a href=\"package\">GitHub Package Registry</a> 到现在还没上线呢。</p>\n<h2 id=\"新建-Actions\"><a href=\"#新建-Actions\" class=\"headerlink\" title=\"新建 Actions\"></a>新建 Actions</h2><h3 id=\"Secrets\"><a href=\"#Secrets\" class=\"headerlink\" title=\"Secrets\"></a>Secrets</h3><p>在 GitHub 设置生成一个 <a href=\"https://github.com/settings/tokens/new\" title=\"New Token\" target=\"_blank\" rel=\"noopener\">Token</a>，需要有仓库的读写权限。打开项目设置，增加 <strong>Secrets</strong> <code>GH_TOKEN</code> 保存刚刚生成的 Token。Actions 默认有个 secret <code>GITHUB_TOKEN</code>，试了下不成功。</p>\n<h3 id=\"Workflow\"><a href=\"#Workflow\" class=\"headerlink\" title=\"Workflow\"></a>Workflow</h3><p>新建 Workflow 文件必须在 <code>.github/workflows</code> 目录中，采用 <a href=\"http://www.ruanyifeng.com/blog/2016/07/yaml.html\" title=\"YAML\" target=\"_blank\" rel=\"noopener\">YAML</a> 语法，名字随意，我命名为 <code>deploy.yml</code>。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Hexo</span> <span class=\"string\">deployer</span> <span class=\"comment\"># Actions 名字</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span> <span class=\"comment\"># 触发条件</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">hexo-config</span> <span class=\"comment\"># 仅向 hexo-config 分支 push 时触发</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span> <span class=\"comment\"># job id</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">and</span> <span class=\"string\">publish</span> <span class=\"comment\"># job 名，不写默认使用 job id</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span> <span class=\"comment\"># 运行环境，可选 ubuntu-latest, ubuntu-18.04, ubuntu-16.04, windows-latest, windows-2019, windows-2016, macOS-latest, macOS-10.14</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Use</span> <span class=\"string\">Node.js</span> <span class=\"number\">10.</span><span class=\"string\">x</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">actions/setup-node@v1</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"attr\">node-version:</span> <span class=\"number\">10.</span><span class=\"string\">x</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Setup</span> <span class=\"string\">hexo</span> <span class=\"string\">env</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">hexo-cli</span> <span class=\"string\">-g</span></span><br><span class=\"line\">          <span class=\"string\">npm</span> <span class=\"string\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Generate</span> <span class=\"string\">public</span> <span class=\"string\">files</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">hexo</span> <span class=\"string\">clean</span></span><br><span class=\"line\">          <span class=\"string\">hexo</span> <span class=\"string\">g</span>  </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Deploy</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"attr\">GH_REF:</span> <span class=\"string\">github.com/Honye/Honye.github.io.git</span></span><br><span class=\"line\">        <span class=\"attr\">GH_TOKEN:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GH_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">config</span> <span class=\"string\">--global</span> <span class=\"string\">user.name</span> <span class=\"string\">\"Honye\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">config</span> <span class=\"string\">--global</span> <span class=\"string\">user.email</span> <span class=\"string\">\"hongye.jun@qq.com\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">clone</span> <span class=\"string\">https://$&#123;GH_REF&#125;</span> <span class=\"string\">.deploy_git</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">.deploy_git</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">checkout</span> <span class=\"string\">master</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">../</span></span><br><span class=\"line\">          <span class=\"string\">mv</span> <span class=\"string\">.deploy_git/.git/</span> <span class=\"string\">./public/</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">./public/</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">add</span> <span class=\"string\">.</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">commit</span> <span class=\"string\">-m</span> <span class=\"string\">\"CI built at `date +\"</span><span class=\"string\">%Y-%m-%d</span> <span class=\"string\">%H:%M:%S\"`\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">push</span> <span class=\"string\">--force</span> <span class=\"string\">--quiet</span> <span class=\"string\">\"https://$&#123;GH_TOKEN&#125;@$&#123;GH_REF&#125;\"</span> <span class=\"string\">master:master</span></span><br></pre></td></tr></table></figure>\n\n","more":"<p>博客原先是使用 <a href=\"https://travis-ci.org/\" title=\"Travis CI\" target=\"_blank\" rel=\"noopener\">Travis</a> 实现自动部署的，现 GitHub 有个 <a href=\"https://github.com/features/actions\" title=\"GitHub Actions\" target=\"_blank\" rel=\"noopener\">Actions</a> 体验 CI 功能就试试。项目中还保留着 Travis 配置，只是关掉了，不能使用 Actions 的是可以使用 Travis。</p>\n<blockquote>\n<p>GitHub 操作可让您灵活地构建自动化的软件部署生命周期工作流程。您可以编写个别任务、调用的操作，以及结合它们创建自定义工作流程。 工作流程是您可以在仓库中创建的自定义自动化流程，用于在 GitHub 上构建、测试、封装、发行或部署任何代码项目。</p>\n</blockquote>\n<p>GitHub Actions 目前采用 <a href=\"yaml\">YAML</a> 语法，还处于体验版，何时能正式上线就不知道了。毕竟 <a href=\"package\">GitHub Package Registry</a> 到现在还没上线呢。</p>\n<h2 id=\"新建-Actions\"><a href=\"#新建-Actions\" class=\"headerlink\" title=\"新建 Actions\"></a>新建 Actions</h2><h3 id=\"Secrets\"><a href=\"#Secrets\" class=\"headerlink\" title=\"Secrets\"></a>Secrets</h3><p>在 GitHub 设置生成一个 <a href=\"https://github.com/settings/tokens/new\" title=\"New Token\" target=\"_blank\" rel=\"noopener\">Token</a>，需要有仓库的读写权限。打开项目设置，增加 <strong>Secrets</strong> <code>GH_TOKEN</code> 保存刚刚生成的 Token。Actions 默认有个 secret <code>GITHUB_TOKEN</code>，试了下不成功。</p>\n<h3 id=\"Workflow\"><a href=\"#Workflow\" class=\"headerlink\" title=\"Workflow\"></a>Workflow</h3><p>新建 Workflow 文件必须在 <code>.github/workflows</code> 目录中，采用 <a href=\"http://www.ruanyifeng.com/blog/2016/07/yaml.html\" title=\"YAML\" target=\"_blank\" rel=\"noopener\">YAML</a> 语法，名字随意，我命名为 <code>deploy.yml</code>。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Hexo</span> <span class=\"string\">deployer</span> <span class=\"comment\"># Actions 名字</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span> <span class=\"comment\"># 触发条件</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">hexo-config</span> <span class=\"comment\"># 仅向 hexo-config 分支 push 时触发</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span> <span class=\"comment\"># job id</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">and</span> <span class=\"string\">publish</span> <span class=\"comment\"># job 名，不写默认使用 job id</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span> <span class=\"comment\"># 运行环境，可选 ubuntu-latest, ubuntu-18.04, ubuntu-16.04, windows-latest, windows-2019, windows-2016, macOS-latest, macOS-10.14</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Use</span> <span class=\"string\">Node.js</span> <span class=\"number\">10.</span><span class=\"string\">x</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">actions/setup-node@v1</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"attr\">node-version:</span> <span class=\"number\">10.</span><span class=\"string\">x</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Setup</span> <span class=\"string\">hexo</span> <span class=\"string\">env</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">npm</span> <span class=\"string\">install</span> <span class=\"string\">hexo-cli</span> <span class=\"string\">-g</span></span><br><span class=\"line\">          <span class=\"string\">npm</span> <span class=\"string\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Generate</span> <span class=\"string\">public</span> <span class=\"string\">files</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">hexo</span> <span class=\"string\">clean</span></span><br><span class=\"line\">          <span class=\"string\">hexo</span> <span class=\"string\">g</span>  </span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Deploy</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"attr\">GH_REF:</span> <span class=\"string\">github.com/Honye/Honye.github.io.git</span></span><br><span class=\"line\">        <span class=\"attr\">GH_TOKEN:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GH_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">config</span> <span class=\"string\">--global</span> <span class=\"string\">user.name</span> <span class=\"string\">\"Honye\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">config</span> <span class=\"string\">--global</span> <span class=\"string\">user.email</span> <span class=\"string\">\"hongye.jun@qq.com\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">clone</span> <span class=\"string\">https://$&#123;GH_REF&#125;</span> <span class=\"string\">.deploy_git</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">.deploy_git</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">checkout</span> <span class=\"string\">master</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">../</span></span><br><span class=\"line\">          <span class=\"string\">mv</span> <span class=\"string\">.deploy_git/.git/</span> <span class=\"string\">./public/</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">./public/</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">add</span> <span class=\"string\">.</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">commit</span> <span class=\"string\">-m</span> <span class=\"string\">\"CI built at `date +\"</span><span class=\"string\">%Y-%m-%d</span> <span class=\"string\">%H:%M:%S\"`\"</span></span><br><span class=\"line\">          <span class=\"string\">git</span> <span class=\"string\">push</span> <span class=\"string\">--force</span> <span class=\"string\">--quiet</span> <span class=\"string\">\"https://$&#123;GH_TOKEN&#125;@$&#123;GH_REF&#125;\"</span> <span class=\"string\">master:master</span></span><br></pre></td></tr></table></figure>\n\n","categories":[],"tags":[{"name":"Hexo","path":"api/tags/Hexo.json"},{"name":"GitHub","path":"api/tags/GitHub.json"}]}